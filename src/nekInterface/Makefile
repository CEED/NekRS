NEKRS_NEKINTERFACE_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))

## Use the Nek5000 makefile generated by nekconfig in working dir
include ${CASEDIR}/makefile

left:= (
right:= )
USR_LFLAGS_:=$(shell echo $(USR_LFLAGS) | sed -E "s@-L$(left)[^ ]+$(right)@-Wl,-rpath,\1 -L\1@g")

NI_LDFLAGS = $(LDFLAGS) -Wl,-rpath,. -L$(OBJDIR) -lnek5000 -ldl $(USR_LFLAGS_)

$(OBJDIR)/nekInterface.o: $(NEKRS_NEKINTERFACE_DIR)/nekInterface.f $(LIB) 
	$(FC) -c $(FL2) $< -o $@ 

libnekInterface: lib$(CASENAME).so

lib$(CASENAME).so: $(LIB) $(USRF) $(OBJDIR)/nekInterface.o
	$(FC) $(FL2) -shared -o lib$(CASENAME).so $(USRF) $(OBJDIR)/nekInterface.o $(NI_LDFLAGS)

#.NOTPARALLEL:

.PHONY: libnekInterface 
